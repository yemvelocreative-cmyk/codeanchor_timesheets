<?php// expects: $reportTitle, $from, $to, $rows, $adminMap, $clientMap, $filterAdminId, $filterClientId, $filterStatus, $totals?><link rel="stylesheet" href="../modules/addons/timekeeper/css/report_output.css" /><div id="ts-audit"><h3 style="margin-top:0;"><?= e($reportTitle) ?></h3><form method="get">  <input type="hidden" name="module" value="timekeeper">  <input type="hidden" name="timekeeperpage" value="reports">  <input type="hidden" name="r" value="timesheet_audit">  <div class="timekeeper-report-filters">    <div class="timekeeper-filter">      <label for="from">From</label>      <input type="date" id="from" name="from" value="<?= e($from) ?>" />    </div>    <div class="timekeeper-filter">      <label for="to">To</label>      <input type="date" id="to" name="to" value="<?= e($to) ?>" />    </div>    <div class="timekeeper-filter">      <label for="admin_id">Admin</label>      <select id="admin_id" name="admin_id">            <option value="0">All Admins</option>            <?php foreach ($adminMap as $id => $name): ?>                <option value="<?= (int)$id ?>" <?= ($filterAdminId == $id ? 'selected' : '') ?>>                    <?= e($name) ?>                </option>            <?php endforeach; ?>        </select>    </div>    <div class="timekeeper-filter">      <label for="client_id">Client</label>      <select id="client_id" name="client_id" class="js-client-select">        <option value="0">All Clients</option>        <?php foreach ($clientMap as $id => $name): ?>            <option value="<?= (int)$id ?>" <?= ($filterClientId == $id ? 'selected' : '') ?>>                <?= e($name) ?>            </option>        <?php endforeach; ?>    </select>    </div>    <div class="timekeeper-filter">      <label for="status">Status</label>        <select id="status" name="status">            <option value="all"      <?= ($filterStatus === 'all' ? 'selected' : '') ?>>All</option>            <option value="pending"  <?= ($filterStatus === 'pending' ? 'selected' : '') ?>>Pending</option>            <option value="approved" <?= ($filterStatus === 'approved' ? 'selected' : '') ?>>Approved</option>            <option value="rejected" <?= ($filterStatus === 'rejected' ? 'selected' : '') ?>>Rejected</option>        </select>    </div>    <div class="timekeeper-filter">      <label for="group_by">Group by</label>      <select id="group_by" name="group_by">        <option value="none"   <?= ($groupBy === 'none'   ? 'selected' : '') ?>>None</option>        <option value="client" <?= ($groupBy === 'client' ? 'selected' : '') ?>>Client</option>        <option value="admin"  <?= ($groupBy === 'admin'  ? 'selected' : '') ?>>Admin</option>      </select>    </div>    <div class="timekeeper-filter action">      <button type="submit" class="btn btn-primary">Apply</button>    </div>    <div class="timekeeper-filter action">      <button type="submit" name="export" value="csv" class="btn btn-success">Export CSV</button>    </div>  </div></form><?php if (empty($rows)): ?>    <div class="timekeeper-report-noresults">No entries found for the selected filters.</div><?php else: ?>    <?php if ($groupBy === 'none'): ?>        <!-- Flat table (no grouping) -->        <div style="overflow-x:auto;">            <table class="timekeeper-report-table">                <thead>                <tr style="white-space:nowrap;">                    <th>Date</th>                    <th>Status</th>                    <th>Admin</th>                    <th>Client</th>                    <th>Department</th>                    <th>Task Category</th>                    <th>Ticket ID</th>                    <th>Description</th>                    <th>Start</th>                    <th>End</th>                    <th>Time Spent</th>                    <th>Billable</th>                    <th>Billable Time</th>                    <th>SLA</th>                    <th>SLA Time</th>                </tr>                </thead>                <tbody>                <?php foreach ($rows as $r): ?>                    <tr>                        <td><?= e($r['timesheet_date']) ?></td>                        <td><?= e(ucfirst($r['timesheet_status'])) ?></td>                        <td><?= e($r['admin_name']) ?></td>                        <td><?= e($r['client_name']) ?></td>                        <td><?= e($r['department']) ?></td>                        <td><?= e($r['task_category']) ?></td>                        <td><?= e($r['ticket_id']) ?></td>                        <td class="description"><?= e($r['description']) ?></td>                        <td><?= e($r['start_time']) ?></td>                        <td><?= e($r['end_time']) ?></td>                        <td><?= e($r['time_spent']) ?></td>                        <td><?= $r['billable'] ? 'Yes' : 'No' ?></td>                        <td><?= e($r['billable_time']) ?></td>                        <td><?= $r['sla'] ? 'Yes' : 'No' ?></td>                        <td><?= e($r['sla_time']) ?></td>                    </tr>                <?php endforeach; ?>                </tbody>            </table>        </div>    <?php else: ?>        <!-- Grouped output: one section per group with per-group totals -->        <?php foreach ($groups as $g): ?>            <h4 style="margin:16px 0 8px 0;">                <?= e($g['label']) ?>                <small style="font-weight:normal; margin-left:10px;">                    (Spent: <?= e($g['totals_fmt']['spent']) ?> |                     Billable: <?= e($g['totals_fmt']['billable']) ?> |                     SLA: <?= e($g['totals_fmt']['sla']) ?>)                </small>            </h4>            <div style="overflow-x:auto;">                <table class="timekeeper-report-table">                    <thead>                    <tr style="white-space:nowrap;">                        <th>Date</th>                        <th>Status</th>                        <th>Admin</th>                        <th>Client</th>                        <th>Department</th>                        <th>Task Category</th>                        <th>Ticket ID</th>                        <th>Description</th>                        <th>Start</th>                        <th>End</th>                        <th>Time Spent</th>                        <th>Billable</th>                        <th>Billable Time</th>                        <th>SLA</th>                        <th>SLA Time</th>                    </tr>                    </thead>                    <tbody>                    <?php foreach ($g['rows'] as $r): ?>                        <tr>                            <td><?= e($r['timesheet_date']) ?></td>                            <td><?= e(ucfirst($r['timesheet_status'])) ?></td>                            <td><?= e($r['admin_name']) ?></td>                            <td><?= e($r['client_name']) ?></td>                            <td><?= e($r['department']) ?></td>                            <td><?= e($r['task_category']) ?></td>                            <td><?= e($r['ticket_id']) ?></td>                            <td class="description"><?= e($r['description']) ?></td>                            <td><?= e($r['start_time']) ?></td>                            <td><?= e($r['end_time']) ?></td>                            <td><?= e($r['time_spent']) ?></td>                            <td><?= $r['billable'] ? 'Yes' : 'No' ?></td>                            <td><?= e($r['billable_time']) ?></td>                            <td><?= $r['sla'] ? 'Yes' : 'No' ?></td>                            <td><?= e($r['sla_time']) ?></td>                        </tr>                    <?php endforeach; ?>                    </tbody>                </table>            </div>        <?php endforeach; ?>    <?php endif; ?>    <!-- Grand Totals -->    <div class="timekeeper-report-totals">        <strong>Totals:</strong>        <span>Time Spent: <?= e($totals['spent_hhmm']) ?></span>        <span>Billable Time: <?= e($totals['billable_hhmm']) ?></span>        <span>SLA Time: <?= e($totals['sla_hhmm']) ?></span>    </div><?php endif; ?></div><script>// Progressive enhancement for client search(function() {    // If Select2 exists, use it with a smart matcher    var hasSelect2 = (window.jQuery && jQuery.fn && typeof jQuery.fn.select2 === 'function');    if (hasSelect2) {        var $ = window.jQuery;        function customMatcher(params, data) {            if ($.trim(params.term) === '') return data;            if (typeof data.text === 'undefined') return null;            var term = params.term.toLowerCase();            var text = (data.text || '').toLowerCase();            return text.indexOf(term) > -1 ? data : null;        }        $('.js-client-select').select2({          width: 'style',       // respects the 260px CSS width          placeholder: 'All Clients',          allowClear: true,          matcher: customMatcher        });        // Ensure width fits our layout        $('.js-client-select').css('min-width', '260px');        return;    }    // Fallback: add a tiny filter input that narrows the options    var clientSelect = document.getElementById('client_id');    if (!clientSelect) return;    var wrapper = document.createElement('div');    wrapper.style.display = 'flex';    wrapper.style.flexDirection = 'column';    wrapper.style.gap = '6px';    // Insert wrapper before the select and move the select inside it    clientSelect.parentNode.insertBefore(wrapper, clientSelect);    wrapper.appendChild(clientSelect);    var filter = document.createElement('input');    filter.type = 'text';    filter.placeholder = 'Type to filter clients...';    filter.style.padding = '6px';    filter.style.minWidth = '260px';    wrapper.insertBefore(filter, clientSelect);    filter.addEventListener('input', function() {        var q = this.value.toLowerCase();        var opts = clientSelect.options;        var selectedStillVisible = false;        for (var i = 0; i < opts.length; i++) {            var text = (opts[i].text || '').toLowerCase();            var match = (q === '') || (text.indexOf(q) > -1) || (opts[i].value === '0'); // keep "All Clients"            opts[i].style.display = match ? '' : 'none';            if (match && opts[i].selected) selectedStillVisible = true;        }        // If the current selection is filtered out, reset to "All Clients"        if (!selectedStillVisible) {            clientSelect.value = '0';        }    });})();</script>